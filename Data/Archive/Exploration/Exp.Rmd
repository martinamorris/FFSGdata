---
title: "Exploration before Exploitation"
output: html_document
---
## Summary ##
We will work on the following issues in order to get a
better picture of the data that we are working with before
creating any statistical models:
  - Variable Identification
  - Univariate Analysis
  - Bi-variate Analysis
  - Missing values treatment
  - Outlier treatment
  - Variable transformation
  - Variable creation

```{r echo = FALSE, include=FALSE}
library(dplyr)
library(plotly)
library(lubridate)


path = here::here(file.path('Data','ffsgData' ,'R', 'Scraping'))
scraped_files = c("fe.clean.Rdata", "MPV.clean.Rdata", "KBP.clean.Rdata", "WaPo.clean.Rdata")
for (file in scraped_files) {
  scraped_path = file.path(path, '..', 'Scraping', "ScrapedFiles", file)
  load(scraped_path)
}

kbp$Date <- as.character.factor(kbp$Date)
kbp$Date <- as.Date(kbp$Date, format = "%m/%d/%Y")
mpv$`Date of Incident (month/day/year)` <-  as.Date(mpv$`Date of Incident (month/day/year)`)


```

 
<!--  it is already cleaned
## Exploration cleaning (must be in trivial amounts only here) ## -->
<!-- Remove the non-police killings from Fatal encounters   -->
<!-- ```{r} -->
<!-- #fe.clean <- filter(fe.clean, fe.clean$kbp.filter == "killed by police") -->
<!-- ``` -->

## Number of records worth matching ##
First, we determine the number of records that can potentially be matched. These are the records that are
recorded when all the specified datasets are in existence. As of this writing, Killed by police is the most
recent dataset as determined by its date of creation (2013). So, we will look at numbers partitioned at 2013:
```{r echo = FALSE}
fe_before_2013 <- nrow(filter(fe.clean, fe.clean$year < 2013))
fe_after_2013 <- nrow(filter(fe.clean, fe.clean$year >= 2013))

kbp_before_2013 <- nrow(filter(kbp, year(kbp$Date) < 2013)) #there is no year column
kbp_after_2013 <- nrow(filter(kbp, year(kbp$Date) >= 2013))

wp_before_2013 <- nrow(filter(wapo, year(wapo$date)< 2013 ))
wp_after_2013 <- nrow(filter(wapo, year(wapo$date) >= 2013 ))

mpv_before_2013 <-  nrow(filter(mpv, year(mpv$`Date of Incident (month/day/year)`)< 2013 ))
mpv_after_2013 <-  nrow(filter(mpv, year(mpv$`Date of Incident (month/day/year)`) >= 2013 ))

before_2013 <- c(fe_before_2013, kbp_before_2013, wp_before_2013, mpv_before_2013 )
after_2013 <- c(fe_after_2013, kbp_after_2013,wp_after_2013, mpv_after_2013)
dfs <- c("Fatal encounters", "Killed by Police", "Washington Post", "Mapping Police Violence")
data <- data.frame(dfs, before_2013, after_2013)
p <- plot_ly(data, x = ~dfs, y = ~before_2013, type = 'bar', name = 'Before 2013',
        marker = list(color = 'rgb(55, 83, 109)')) %>%
  add_trace(y = ~after_2013, name = 'After 2013', marker = list(color = 'rgb(26, 118, 255)')) %>%
    layout(title = "Number of records as partiitoned by the origin date of most recently created dataset",
           yaxis = list(title = "Number of records"), xaxis = list(title = "Dataset"), barmode = 'group', bargap = 0.15)
p
```
As seen above, we have no case reported before 2013 for Killed by police, Mapping Police Violence and Washington Post  compared to majority of Fatal encounters' data recorded before 2013. Also note that even after 2013 fatal encounters records much more than the other datatsets. Henceforth, we shall only use the data from 2013 since that is the only data worth matching.

```{r echo = FALSE}
fe.clean <- filter(fe.clean, fe.clean$year >= 2013)
```

## Univariate Analysis for Age ##
Here we look at the age variable recorded by all datasets (albeit under different column names). **Pay special attention to warnings to figure out what needs to be cleaned in the datasets since these warnings tell age entries that are anomalous like 25-30, 17 months, 40s, etc.**

First, fatal encounters:
Total age records are 
```{r echo = FALSE}
nrow(fe.clean)
```


Total missing age records are: 
```{r echo = FALSE}
nrow(filter(fe.clean, is.na(fe.clean$age) | fe.clean$age == ""))
```
 
 
Of the non-missing, following is the histogram of occurences:
```{r echo = FALSE}
fe.age.data <- fe.clean$age
p <- plot_ly(x = ~fe.age.data, name = "Fatal encounters", type = "histogram")
p
```

Second, Killed by Police:
Total age records are :
```{r echo = FALSE}
nrow(kbp)
```


Total missing age records are:
```{r echo = FALSE}
nrow(filter(kbp, is.na(kbp$Age) | kbp$Age == ""  ))
```



Of the non-missing, following is the histogram of occurences:
```{r echo = FALSE}
kbp.age.data <- as.factor(kbp$Age)
p <- plot_ly(x = ~kbp.age.data, name = "Killed by Police", type = "histogram")
p
```

Third, Washington post:

Total age records are :

```{r echo = FALSE }
nrow(wapo)
```

Total missing age records are
```{r echo = FALSE}
missing.wp<- filter(wapo, is.na( wapo$age) | wapo$age == "")
nrow(missing.wp)
```

Of the non-missing, following is the histogram of occurences:
```{r echo = FALSE}
wp.age.data <- as.factor(wapo$age)
p <- plot_ly(x = ~wp.age.data, name = "Washington post", type = "histogram")
p
```


Fourth, Mapping Police Violence:

Total age records are :

```{r echo = FALSE}
nrow(mpv)
```


Total missing age records are
```{r echo = FALSE}
missing.mpv<- filter(mpv, is.na(mpv$`Victim's age`) | mpv$`Victim's age` == "")
nrow(missing.mpv)
```


Of the non-missing, following is the histogram of occurences:
```{r echo = FALSE}
mpv.age.data <- as.factor(mpv$`Victim's age`)
p <- plot_ly(x = ~mpv.age.data, name = "Mapping Police Violence", type = "histogram")
p
```


Finally, all datasets:
```{r echo = FALSE }

fe.age.data <- fe.clean$age
kbp.age.data <- as.factor(kbp$Age)
wp.age.data <- as.factor(wapo$age)
mpv.age.data <- as.factor(mpv$`Victim's age`)

p <- plot_ly(alpha = 0.6) %>%
  add_histogram(x = ~fe.age.data, name = "Fatal encounters") %>%
  add_histogram(x = ~kbp.age.data, name = "Killed by Police") %>%
  add_histogram(x = ~wp.age.data, name = "Washington post") %>%
   add_histogram(x = ~mpv.age.data, name = "Mapping Police Violence") %>%
  layout(barmode = "overlay", xaxis = list(title = "Age"))
p
```


## Univariate Analysis for Race ##
Same procedure as for age. We begin by plotting the statistics separately and then together stacked one on the top of the other.
This should allow us to see the relative density of races recorded in each dataset. More importantly, it should allow us to see the race categories encoded in the datasets and how the matching algorithm should compare them.

First, fatal encounters:
Total race records are:
```{r echo = FALSE }
nrow(fe.clean)
```



Total missing age records are:
```{r echo = FALSE}
nrow(filter(fe.clean, is.na(fe.clean$race) | fe.clean$race == ""))
```


Of the non-missing, following is the histogram of occurences.
```{r echo = FALSE}
fe.race.data <- fe.clean$race
p <- plot_ly(x = ~fe.race.data, name = "Fatal encounters", type = "histogram")
p
```


Second, Killed by Police:
Total race records are : 
```{r echo = FALSE}
nrow(kbp)
```


Total missing age records are :
```{r echo = FALSE}
nrow(filter(kbp, is.na(kbp$Race)))
```



Of the non-missing, following is the histogram of occurences.
```{r echo = FALSE}
kbp.race <- kbp$Race
p <- plot_ly(x = ~kbp.race, name = "Killed by Police", type = "histogram")
p
```


Third, Mapping Police Violence:

Total race records are:
```{r echo = FALSE}
nrow(mpv)
```

Total missing age records ar:
```{r  echo = FALSE }
nrow(filter(mpv, is.na(mpv$`Victim's race`)))
```


Of thte non-missing, following is the histogram of occurences.
```{r echo = FALSE}
p <- plot_ly(x = ~mpv$`Victim's race`, name = "Mapping Police Violence", type = "histogram")
p
```


Fouth, Washington Post:
Total race records are:
```{r echo = FALSE}
nrow(wapo)
```

Total missing age records are
```{r  echo = FALSE}
nrow(filter(wapo, is.na(wapo$race) | wapo$race == ""))
```

Of the non-missing, following is the histogram of occurences.
```{r echo = FALSE}
p <- plot_ly(x = ~wapo$race, name = "Washington Post", type = "histogram")
p
```





<!-- TODO: -->
<!-- - general missingness -->
<!-- - missing density by date -->
<!-- - Relationship between variables -->
<!-- - Variable transformation -->

<!-- ----- Handle missing data??? ------ use the previous model ------ predict and analyze ----- Merging???? -->