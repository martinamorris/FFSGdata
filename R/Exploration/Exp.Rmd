---
title: "Exploration before Exploitation"
output:
  html_document:
    code_folding: hide
---
## Summary ##
We will work on the following issues in order to get a
better picture of the data that we are working with before
creating any statistical models:
  - Variable Identification
  - Univariate Analysis
  - Bi-variate Analysis
  - Missing values treatment
  - Outlier treatment
  - Variable transformation
  - Variable creation

```{r, include= FALSE}
library(dplyr)
library(plotly)
library(lubridate)
library(tidyr)
library(plyr)


path = here::here(file.path('R', 'Scraping'))

path2 = here::here(file.path( 'R','Harmonizing', 'HarmonizedFiles'))
load( file.path(path2, "HarmonizedDataSets.RData"))
scraped_files = c("fe.clean.Rdata", "MPV.clean.Rdata", "KBP.clean.Rdata", "WaPo.clean.Rdata")

for (file in scraped_files) {
  scraped_path = file.path(path, '..', 'Scraping', "ScrapedFiles", file)
  load(scraped_path)
}

options(stringsAsFactors = FALSE)

kbp$Date <- as.character.factor(kbp$Date)
kbp$Date <- as.Date(kbp$Date, format = "%m/%d/%Y")
mpv$`Date of Incident (month/day/year)` <-  as.Date(mpv$`Date of Incident (month/day/year)`)

```

 

## Number of records worth matching ##
First, we determine the number of records that can potentially be matched. These are the records that are
recorded when all the specified datasets are in existence. As of this writing, Killed by police is the most
recent dataset as determined by its date of creation (2013). So, we will look at numbers partitioned at 2013:
```{r}
fe_before_2013 <- nrow(filter(fe_clean, fe_clean$year < 2013))
fe_after_2013 <- nrow(filter(fe_clean, fe_clean$year >= 2013))

kbp_before_2013 <- nrow(filter(kbp, year(kbp$Date) < 2013)) #there is no year column
kbp_after_2013 <- nrow(filter(kbp, year(kbp$Date) >= 2013))

wp_before_2013 <- nrow(filter(wapo, year(wapo$date)< 2013 ))
wp_after_2013 <- nrow(filter(wapo, year(wapo$date) >= 2013 ))

mpv_before_2013 <-  nrow(filter(mpv, 
                                year(mpv$`Date of Incident (month/day/year)`)< 2013 ))
mpv_after_2013 <-  nrow(filter(mpv, 
                               year(mpv$`Date of Incident (month/day/year)`) >= 2013 ))

before_2013 <- c(fe_before_2013, 
                 kbp_before_2013, 
                 wp_before_2013, 
                 mpv_before_2013)

after_2013 <- c(fe_after_2013, 
                kbp_after_2013,
                wp_after_2013, 
                mpv_after_2013)

dfs <- c("Fatal encounters", 
         "Killed by Police", 
         "Washington Post", 
         "Mapping Police Violence")

data <- data.frame(dfs, 
                   before_2013, 
                   after_2013)

p.raw <- plot_ly(data, x = ~dfs, y = ~before_2013, 
                 type = 'bar', 
                 name = 'Before 2013',
                 marker = list(color = 'rgb(55, 83, 109)')) %>%
  add_trace(y = ~after_2013, 
            name = 'After 2013', 
            marker = list(color = 'rgb(26, 118, 255)')) %>%
  layout(title = "Number of records",
         yaxis = list(title = "Number of records"), 
         xaxis = list(title = "Dataset"), 
         barmode = 'group', 
         bargap = 0.15)
p.raw

#harmonized data
hfe_before_2013 <- nrow(filter(fe_harmonized, 
                               fe_harmonized$year < 2013))
hfe_after_2013 <- nrow(filter(fe_harmonized, 
                              fe_harmonized$year >= 2013))

hkbp_before_2013 <- nrow(filter(kbp_harmonized,
                                year(kbp_harmonized$date) < 2013))

hkbp_after_2013 <- nrow(filter(kbp_harmonized, 
                               year(kbp_harmonized$date) >= 2013))

hwp_before_2013 <- nrow(filter(wapo_harmonized,
                               year(wapo_harmonized$date)< 2013 ))
hwp_after_2013 <- nrow(filter(wapo_harmonized, 
                              year(wapo_harmonized$date) >= 2013 ))

hmpv_before_2013 <-  nrow(filter(mpv_harmonized,
                                 year(mpv_harmonized$date)< 2013 ))
hmpv_after_2013 <-  nrow(filter(mpv_harmonized,
                                year(mpv_harmonized$date) >= 2013 ))

hbefore_2013 <- c(hfe_before_2013,
                  hkbp_before_2013,
                  hwp_before_2013,
                  hmpv_before_2013 )

hafter_2013 <- c(hfe_after_2013,
                 hkbp_after_2013,
                 hwp_after_2013,
                 hmpv_after_2013)

hdfs <- c("Fatal encounters", 
          "Killed by Police", 
          "Washington Post", 
          "Mapping Police Violence")

hdata <- data.frame(hdfs, 
                    hbefore_2013, 
                    hafter_2013)

p.har <- plot_ly(hdata, x = ~hdfs, y = ~hbefore_2013, 
                 type = 'bar', 
                 name = 'Before 2013',
                 marker = list(color = 'rgb(55, 83, 109)')) %>%
  add_trace(y = ~hafter_2013, 
            name = 'After 2013', 
            marker = list(color = 'rgb(26,118,255)')) %>%
  layout(title = "Number of records", 
         yaxis = list(title = "Number of records"),          
         xaxis = list(title = "Harmonized Dataset"), 
         barmode = 'group', bargap = 0.15)
p.har

```
As seen above, we have no case reported before 2013 for Killed by police, Mapping Police Violence and Washington Post  compared to majority of Fatal encounters' data recorded before 2013. Also note that even after 2013 fatal encounters records much more than the other datatsets. Henceforth, we shall only use the data from 2013 since that is the only data worth matching.

```{r}
fe_clean <- filter(fe_clean, fe_clean$year >= 2013)
fe_harmonized <- filter(fe_harmonized, fe_harmonized$year >= 2013)
```

## Univariate Analysis for Age ##
Here we look at the age variable recorded by all datasets (albeit under different column names).

First, fatal encounters:

Total age records for raw data are **`r nrow(fe_clean)` .**

Total age records for harmonized data are **`r length(fe_harmonized$age)`**



_Total missing age records are: _

Raw data : **`r nrow(filter(fe_clean, is.na(fe_clean$age) | fe_clean$age == ""))`**

Harmonized data :**`r nrow(filter(fe_harmonized, is.na(fe_harmonized$age) | fe_harmonized$age == ""))`**

 
 
Following is the histogram of occurences:
```{r}

fe_clean = fe_clean %>% 
  mutate( age = replace(age, age == "", "Missing"))

p.raw <- plot_ly(x = ~fe_clean$age, type = "histogram") %>% 
  layout( xaxis = list( title = "Fatal encounters, Raw dataset"))
p.raw

fe_harmonized$age = fe_harmonized$age %>%
  replace_na("Missing")
p.har <- plot_ly(x = ~fe_harmonized$age, type = "histogram") %>% 
  layout( xaxis = list(title = "Fatal encounters, Harmonized datset"))
p.har


```

Second, Killed by Police:

Total age records for raw data are **`r nrow(kbp)`.**

Total age records for harmonized data are **`r nrow(kbp_harmonized)`**


_Total missing age records are:_

Raw data: **`r nrow(filter(kbp, is.na(kbp$Age) | kbp$Age == ""  )) `**

Harmonized data: **`r nrow(filter(kbp_harmonized, is.na(kbp_harmonized$age) | kbp_harmonized$age == ""  ))`**


Following is the histogram of occurences:
```{r}
kbp$Age <- as.character(kbp$Age)
kbp <-  kbp %>% 
  mutate( Age = replace(Age, Age == "", "Missing"))
p.raw <- plot_ly(x = ~kbp$Age, type = "histogram")  %>% 
  layout( xaxis = list(title = "Killed by Police, Raw dataset"))
p.raw 


kbp_harmonized$age = kbp_harmonized$age %>%  replace_na("Missing")
p.har <- plot_ly(x = ~as.factor(kbp_harmonized$age), type = "histogram")  %>% 
  layout( xaxis = list(title = "Killed by Police, Harmonized dataset"))
p.har
```

Third, Washington post:

Total age records for raw data are **`r nrow(wapo)`**

Total age records for harmonized data are **`r nrow(wapo_harmonized)`** 


_Total missing age records are: _

Raw data: **`r nrow(filter(wapo, is.na( wapo$age) | wapo$age == "")) `** 

Harmonized data: **`r nrow(filter(wapo_harmonized, is.na( wapo_harmonized$age) | wapo_harmonized$age == ""))`**

Following is the histogram of occurences:
```{r}


wapo$age = wapo$age %>% replace_na("Missing")
p.raw <- plot_ly(x = ~wapo$age,type = "histogram")   %>% 
  layout( xaxis = list(title = "Washington post, Raw dataset"))
p.raw


wapo_harmonized$age = wapo_harmonized$age %>% replace_na("Missing")
p.har <- plot_ly(x = ~wapo_harmonized$age, type = "histogram")  %>% 
  layout( xaxis = list(title = "Washington post, Harmonized datset"))
p.har



```


Fourth, Mapping Police Violence:

Total age records for raw data are **`r nrow(mpv)`** 

Total age records for harmonized data are **`r nrow(mpv_harmonized)`**



_Total missing age records are :_
Raw data : 
```{r}
nrow(filter(mpv, is.na(mpv$`Victim's age`) | mpv$`Victim's age` == "Unknown"))
```
Harmonized data: **`r nrow(filter(mpv, is.na(mpv_harmonized$age) | mpv_harmonized$age == ""))`**

Following is the histogram of occurences:
```{r}
mpv$`Victim's age`=  mpv$`Victim's age` %>% 
                     replace_na("Missing")

mpv$`Victim's age` =replace(mpv$`Victim's age`, which(mpv$`Victim's age`=="Unknown"), "Missing")


p.raw <- plot_ly(x = ~mpv$`Victim's age`, type = "histogram")  %>% 
  layout( xaxis = list(title = "Mapping Police Violence, Raw data"))
p.raw

mpv_harmonized$age= mpv_harmonized$age %>% replace_na("Missing")
p.har <- plot_ly(x = ~mpv_harmonized$age, name = , type = "histogram")  %>% 
  layout( xaxis = list(title = "Mapping Police Violence, Harmonized data"))
p.har


```


Finally, all datasets:
```{r}

p.raw <- plot_ly(alpha = 0.6) %>%
  add_histogram(x = ~fe_clean$age, name = "Fatal encounters") %>%
  add_histogram(x = ~kbp$Age, name = "Killed by Police") %>%
  add_histogram(x = ~wapo$age, name = "Washington post") %>%
   add_histogram(x = ~mpv$`Victim's age`, name = "Mapping Police Violence") %>%
  layout(barmode = "overlay", xaxis = list(title = "Age, Raw dataset"))
p.raw

p.har <- plot_ly(alpha = 0.6) %>%
  add_histogram(x = ~fe_harmonized$age, name = "Fatal encounters") %>%
  add_histogram(x = ~kbp_harmonized$age, name = "Killed by Police") %>%
  add_histogram(x = ~wapo_harmonized$age, name = "Washington post") %>%
   add_histogram(x = ~mpv_harmonized$age, name = "Mapping Police Violence") %>%
  layout(barmode = "overlay", xaxis = list(title = "Age, harmonized dataset"))
p.har


```


## Univariate Analysis for Race ##
Same procedure as for age. We begin by plotting the statistics separately and then together stacked one on the top of the other.
This should allow us to see the relative density of races recorded in each dataset. More importantly, it should allow us to see the race categories encoded in the datasets and how the matching algorithm should compare them.

First, fatal encounters:
Total race records are: **`r length(fe_clean$race)`**



_Total missing race records are: _

Raw data: **`r nrow(filter(fe_clean, is.na(fe_clean$race) | fe_clean$race == "Missing" | fe_clean$race == "Race unspecified" ))  `** 

Harmonized data: **`r nrow(filter(fe_harmonized, is.na(fe_harmonized$race) | fe_harmonized$race == "")) `**


Following is the histogram of occurences.
```{r}
fe_clean$race<- replace(fe_clean$race, fe_clean$race== "Race unspecified", "Missing")
p.raw <- plot_ly(x = ~fe_clean$race, type = "histogram", color =  ~fe_clean$race)  %>% 
  layout( xaxis = list(title ="Fatal encounters, raw dataset"))
p.raw

fe_harmonized$race<- replace(fe_harmonized$race, is.na(fe_harmonized$race), "Missing")
p.har <- plot_ly(x = ~fe_harmonized$race, type = "histogram", color = ~replace(fe_harmonized$race, is.na(fe_harmonized$race), "NA"))  %>% 
  layout( xaxis = list(title =  "Fatal encounters, harmonized dataset"))
p.har



```


Second, Killed by Police:

Total race records are :  **`r nrow(kbp)`**


_Total missing race records are :_

Raw data: **`r nrow(filter(kbp, is.na(kbp$Race) | kbp$Race == ""))`** 

Harmonized data: **`r nrow(filter(kbp_harmonized, is.na(kbp_harmonized$race)))`**


Following is the histogram of occurences.
```{r}

kbp$Race = as.character(kbp$Race) %>%   replace_na("Missing")
p.raw  <- plot_ly(x = ~kbp$Race, type = "histogram") %>% 
  layout( xaxis = list(title =  "Killed by Police, raw data"))
p.raw

kbp_harmonized$race = as.character(kbp_harmonized$race) %>%   replace_na("Missing")

p.har <- plot_ly(x = ~kbp_harmonized$race, type = "histogram", color = ~kbp_harmonized$race)  %>%  
  layout( xaxis = list(title = "Killed by Police, harmonized data"))
p.har
```


Third, Mapping Police Violence:

Total race records are: **`r nrow(mpv)`**

_Total missing race records are:_
Raw data :
```{r}
nrow(filter(mpv, mpv$`Victim's race` == "Unknown Race"  |mpv$`Victim's race` == "Unknown race" ))

```

Harmonized data : `r nrow(filter(mpv_harmonized, is.na(mpv_harmonized$race)))`

Following is the histogram of occurences.
```{r}
mpv$`Victim's race` = tolower(mpv$`Victim's race`)
  
p <- plot_ly(x = ~mpv$`Victim's race`, type = "histogram", color = ~mpv$`Victim's race`)  %>%  
  layout( xaxis = list(title =   "Mapping Police Violence, raw data"))
p

mpv_harmonized$race = mpv_harmonized$race %>%   replace_na("Missing")
p.har <- plot_ly(x = ~mpv_harmonized$race, name = , type = "histogram", color= ~mpv_harmonized$race)  %>%  
  layout( xaxis = list(title = "Mapping Police Violence, harmonized data"))
p.har
```


Fourth, Washington Post: 

Total race records are: **`r length(wapo$race)`**

_Total missing race records are:_

Raw data:
```{r}
nrow(filter(wapo, is.na(wapo$race) | wapo$race == "" | wapo$race == "Missing"))
```


Harmonized data:
```{r}
nrow(filter(wapo_harmonized, is.na(wapo_harmonized$race) | wapo_harmonized$race == "" | wapo_harmonized$race == "Missing" ))
```


Following is the histogram of occurences.
```{r}

wapo$race = wapo$race %>% replace_na("Missing")
p.raw <- plot_ly(x = ~wapo$race, type = "histogram", color = ~wapo$race) %>%
  layout( xaxis = list(title =   "Washington Post, raw data"))
p.raw


wapo_harmonized$race = wapo_harmonized$race %>%   replace_na("Missing")
p.har <- plot_ly(x = ~wapo_harmonized$race,type = "histogram", color = ~wapo_harmonized$race )  %>%  
  layout( xaxis = list(title = "Washington Post, harmonized data"))
p.har
```


Finally, all datasets:
```{r}

p.raw <- plot_ly(alpha = 0.6) %>%
  add_histogram(x = ~fe_clean$race, name = "Fatal encounters") %>%
  add_histogram(x = ~kbp$Race, name = "Killed by Police") %>%
  add_histogram(x = ~wapo$race, name = "Washington post") %>%
   add_histogram(x = ~mpv$`Victim's race`, name = "Mapping Police Violence") %>%
  layout(barmode = "overlay", xaxis = list(title = "Race, Raw dataset"))
p.raw

p.har <- plot_ly(alpha = 0.6) %>%
  add_histogram(x = ~fe_harmonized$race, name = "Fatal encounters") %>%
  add_histogram(x = ~kbp_harmonized$race, name = "Killed by Police") %>%
  add_histogram(x = ~wapo_harmonized$race, name = "Washington post") %>%
   add_histogram(x = ~mpv_harmonized$race, name = "Mapping Police Violence") %>%
  layout(barmode = "overlay", xaxis = list(title = "Race, harmonized dataset"))
p.har


```


<!-- TODO: -->
<!-- - general missingness -->
<!-- - missing density by date -->
<!-- - Relationship between variables -->
<!-- - Variable transformation -->

<!-- ----- Handle missing data??? ------ use the previous model ------ predict and analyze ----- Merging???? -->